<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Vehicle Statistics Visualization</title>
    <style>
        /* Previous styles remain the same */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .chart-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        #chart {
            width: 100%;
            height: 600px;
        }

        .tooltip {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            padding: 10px;
            pointer-events: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: grab;
            transition: all 0.3s ease;
            position: relative;
            background-color: white;
        }

        .legend-item:hover {
            background-color: #f5f5f5;
            border-color: #999;
        }

        .legend-item:active {
            cursor: grabbing;
        }

        .legend-item::after {
            content: "æ‹–æ›³æˆ‘";
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #666;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .legend-item:hover::after {
            opacity: 1;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #ddd;
        }

        .legend-label {
            user-select: none;
        }

        .hint-container {
            position: relative;
            display: inline-block;
            margin-bottom: 10px;
        }

        .hint-icon {
            border-radius: 100%;
            background-color: #f0f0f0;
            font-size: 20px;
            cursor: pointer;
            padding: 10px 10px;
            transition: background-color 0.3s ease;
        }

        .hint-icon:hover {
            background-color: #e0e0e0;
        }

        .hint-tooltip {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            top: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .hint-container:hover .hint-tooltip {
            visibility: visible;
            opacity: 1;
        }

        .inactive {
            opacity: 0.5;
        }

        .inactive .legend-color {
            opacity: 0.3;
        }
    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
</head>
<body>
    <h1>æ–°ç«¹å¸‚æ©Ÿå‹•è»Šè¼›äº’å‹•å¼åœ–è¡¨</h1>
    <div class="hint-container">
        <span class="hint-icon">ğŸ’¡</span>
        <span class="hint-tooltip">
            <ol>
                <li>å°‡æ»‘é¼ ç§»åˆ°é•·æ¢ä¸Šå¯ä»¥çœ‹åˆ°è©³ç´°æ•¸æ“š</li>
                <li>æ‹–å‹•ä¸Šæ–¹çš„åœ–ä¾‹ä¾†æ”¹è®Šè»Šè¼›é¡å‹çš„å †ç–Šé †åº</li>
                <li>é»æ“Šåœ–ä¾‹ä¾†é¡¯ç¤º/éš±è—ç‰¹å®šè»Šè¼›é¡å‹</li>
            </ol>
        </span>
    </div>
    <div id="legend" class="legend"></div>
    
    <div class="chart-container">
        <div id="chart"></div>
    </div>

    <script>
        // Load the data
        d3.csv("app/static/vehicle.csv").then(data => {
            // Process and filter the data, excluding year 113
            const processedData = data
                .filter(d => !d['ç¸½è¨ˆ'].startsWith('113')) // Filter out data from year 113
                .map(d => ({
                    year: d['ç¸½è¨ˆ'],
                    displayYear: d['ç¸½è¨ˆ'].replace(/^(\d+)å¹´.*$/, '$1'),
                    yearNumber: parseInt(d['ç¸½è¨ˆ'].match(/^(\d+)/)[1]),
                    car: +d['æ±½è»Š'].replace(/,/g, ''),
                    bus: +d['å¤§å®¢è»Š'].replace(/,/g, ''),
                    truck: +d['å¤§è²¨è»Š'].replace(/,/g, ''),
                    privatecar: +d['å°å®¢è»Š'].replace(/,/g, ''),
                    van: +d['å°è²¨è»Š'].replace(/,/g, ''),
                    special: +d['ç‰¹ç¨®è»Š'].replace(/,/g, ''),
                    motorcycle: +d['æ©Ÿè»Š'].replace(/,/g, '')
                })).sort((a, b) => a.yearNumber - b.yearNumber);

            // Rest of the code remains the same
            const combinedData = Array.from(d3.group(processedData, d => d.yearNumber))
                .map(([year, values]) => {
                    const combined = {
                        displayYear: values[0].displayYear,
                        yearNumber: year
                    };
                    ["car", "bus", "truck", "privatecar", "van", "special", "motorcycle"].forEach(type => {
                        combined[type] = d3.sum(values, d => d[type]);
                    });
                    return combined;
                });

            const chartContainer = d3.select(".chart-container");
            const containerWidth = chartContainer.node().getBoundingClientRect().width;

            const margin = { top: 40, right: 20, bottom: 70, left: 80 };
            const width = containerWidth - margin.left - margin.right;
            const height = 600 - margin.top - margin.bottom;

            // Create SVG
            const svg = d3.select("#chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Define color mapping with default order
            const defaultOrder = ["car", "bus", "truck", "privatecar", "van", "special", "motorcycle"];
            const colorMapping = {
                "car": "#F28B82",
                "bus": "#64B5F6",
                "truck": "#FFB74D",
                "privatecar": "#7986CB",
                "van": "#FFF176",
                "special": "#BA68C8",
                "motorcycle": "#81C784"
            };

            // Create scales
            const x = d3.scaleBand().range([0, width]).padding(0.1);
            const y = d3.scaleLinear().range([height, 0]);

            // Create axes
            const xAxis = svg.append("g")
                .attr("transform", `translate(0,${height})`);
            const yAxis = svg.append("g");

            // Add axis labels
            svg.append("text")
                .attr("transform", `translate(${width / 2},${height + margin.bottom - 10})`)
                .style("text-anchor", "middle")
                .text("å¹´ä»½");

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("æ•¸é‡");

            // Create tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Helper function for Chinese labels
            function getChineseLabel(key) {
                const labels = {
                    "car": "æ±½è»Š",
                    "bus": "å¤§å®¢è»Š",
                    "truck": "å¤§è²¨è»Š",
                    "privatecar": "å°å®¢è»Š",
                    "van": "å°è²¨è»Š",
                    "special": "ç‰¹ç¨®è»Š",
                    "motorcycle": "æ©Ÿè»Š"
                };
                return labels[key];
            }

            // Create legend
            const legend = d3.select("#legend");
            defaultOrder.forEach(type => {
                const legendItem = legend.append("div")
                    .attr("class", "legend-item")
                    .attr("data-id", type);
                legendItem.append("div")
                    .attr("class", "legend-color")
                    .style("background-color", colorMapping[type]);
                legendItem.append("span")
                    .attr("class", "legend-label")
                    .text(getChineseLabel(type));
            });

            // Make legend sortable
            new Sortable(legend.node(), {
                animation: 150,
                ghostClass: 'blue-background-class',
                onEnd: function (evt) {
                    updateChart();
                },
            });

            // Function to update the chart
            function updateChart() {
                const selectedTypes = Array.from(legend.selectAll('.legend-item'))
                    .filter(item => !d3.select(item).classed('inactive'))
                    .map(item => d3.select(item).attr('data-id'));

                // Set domains
                x.domain(combinedData.map(d => d.displayYear));
                const maxTotal = d3.max(combinedData, d =>
                    selectedTypes.reduce((sum, key) => sum + d[key], 0)
                );
                y.domain([0, maxTotal]);

                // Update axes
                xAxis.transition().duration(1000).call(d3.axisBottom(x));
                yAxis.transition().duration(1000).call(d3.axisLeft(y));

                // Stack the data
                const stackedData = d3.stack()
                    .keys(selectedTypes)(combinedData);

                // Create and update bars
                const bars = svg.selectAll(".bar")
                    .data(stackedData)
                    .join("g")
                    .attr("class", "bar")
                    .attr("fill", d => colorMapping[d.key]);

                bars.selectAll("rect")
                    .data(d => d)
                    .join("rect")
                    .transition()
                    .duration(1000)
                    .attr("x", d => x(d.data.displayYear))
                    .attr("y", d => y(d[1]))
                    .attr("height", d => y(d[0]) - y(d[1]))
                    .attr("width", x.bandwidth());

                // Add interactivity
                bars.selectAll("rect")
                    .on("mouseover", function (event, d) {
                        const category = d3.select(this.parentNode).datum().key;
                        const value = d[1] - d[0];
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);
                        tooltip.html(`${d.data.displayYear}å¹´<br>${getChineseLabel(category)}: ${value.toLocaleString()}`)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function (d) {
                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });
            }

            // Add click event to legend items to toggle visibility
            legend.selectAll('.legend-item').on('click', function() {
                const item = d3.select(this);
                const isActive = !item.classed('inactive');
                item.classed('inactive', isActive);
                updateChart();
            });

            // Initial chart render
            updateChart();
        });
    </script>
</body>
</html>